services:
  # --- APLICAÇÃO PRINCIPAL ---
  
  backend:
    build: .
    container_name: globalstar-backend
    restart: always
    ports:
      - "5000:5000" # Porta da API
      - "5001:5001" # (Opcional) Porta extra se precisar de debug
    environment:
      - SERVER_PORT=:5000
      - DB_HOST=db
      - DB_PORT=3306
      - DB_USER=root
      - DB_PASS=rootpassword
      - DB_NAME=globalstar_db
      - JWT_SECRET=sua_chave_secreta_docker_super_segura
    depends_on:
      - db
    networks:
      - globalstar-net

  frontend:
    build:
      context: ./globalstar-front
      args:
        # URL que o navegador usará para acessar a API
        - VITE_API_URL=http://localhost:5000
        # URL para o WebSocket (se usar env no front)
        - VITE_WS_URL=ws://localhost:5000/ws
    container_name: globalstar-frontend
    restart: always
    ports:
      - "3000:80" # Acesso no navegador: http://localhost:3000
    depends_on:
      - backend
    networks:
      - globalstar-net

  db:
    image: mysql:8.0
    container_name: globalstar-db
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: rootpassword
      MYSQL_DATABASE: globalstar_db
    ports:
      - "3306:3306" # Se der erro de porta em uso, mude para "3307:3306"
    volumes:
      - mysql_data:/var/lib/mysql
      # Script que cria as tabelas na primeira execução
      - ./init.sql:/docker-entrypoint-initdb.d/init.sql
    networks:
      - globalstar-net

  # --- QUALIDADE DE CÓDIGO (SONARQUBE) ---

  sonarqube:
    image: sonarqube:community
    container_name: sonarqube
    restart: always
    ports:
      - "9000:9000" # Acesso: http://localhost:9000 (admin/admin)
    environment:
      - SONAR_JDBC_URL=jdbc:postgresql://db-sonar:5432/sonar
      - SONAR_JDBC_USERNAME=sonar
      - SONAR_JDBC_PASSWORD=sonar
    volumes:
      - sonar_data:/opt/sonarqube/data
      - sonar_extensions:/opt/sonarqube/extensions
      - sonar_logs:/opt/sonarqube/logs
    depends_on:
      - db-sonar
    networks:
      - globalstar-net

  db-sonar:
    image: postgres:13
    container_name: sonarqube-db
    restart: always
    environment:
      - POSTGRES_USER=sonar
      - POSTGRES_PASSWORD=sonar
      - POSTGRES_DB=sonar
    volumes:
      - sonar_db_data:/var/lib/postgresql/data
    networks:
      - globalstar-net

volumes:
  mysql_data:
  sonar_data:
  sonar_extensions:
  sonar_logs:
  sonar_db_data:

networks:
  globalstar-net:
    driver: bridge