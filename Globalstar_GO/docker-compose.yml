services:
  # --- APLICAÇÃO PRINCIPAL ---
  
  backend:
    build: .
    container_name: globalstar-backend
    restart: always
    ports:
      - "5000:5000"
    environment:
      - SERVER_PORT=:5000
      - DB_HOST=db
      - DB_PORT=3306
      - DB_USER=root
      - DB_PASS=rootpassword
      - DB_NAME=globalstar_db
      - JWT_SECRET=sua_chave_secreta_docker
    depends_on:
      - db
    networks:
      - globalstar-net

  frontend:
    build:
      context: ./globalstar-front
      args:
        # Aponta para o backend (acessível pelo browser, então usa localhost ou IP público)
        - VITE_API_URL=http://localhost:5000
    container_name: globalstar-frontend
    restart: always
    ports:
      - "3000:80" # Acessar no navegador via http://localhost:3000
    depends_on:
      - backend
    networks:
      - globalstar-net

  db:
    image: mysql:8.0
    container_name: globalstar-db
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: rootpassword
      MYSQL_DATABASE: globalstar_db
    ports:
      - "3306:3306"
    volumes:
      - mysql_data:/var/lib/mysql
      # Script opcional para criar tabelas ao iniciar (se tiver um init.sql)
      # - ./init.sql:/docker-entrypoint-initdb.d/init.sql
    networks:
      - globalstar-net

  # --- QUALIDADE DE CÓDIGO (SONARQUBE) ---

  sonarqube:
    image: sonarqube:community
    container_name: sonarqube
    restart: always
    ports:
      - "9000:9000"
    environment:
      - SONAR_JDBC_URL=jdbc:postgresql://db-sonar:5432/sonar
      - SONAR_JDBC_USERNAME=sonar
      - SONAR_JDBC_PASSWORD=sonar
    volumes:
      - sonar_data:/opt/sonarqube/data
      - sonar_extensions:/opt/sonarqube/extensions
      - sonar_logs:/opt/sonarqube/logs
    depends_on:
      - db-sonar
    networks:
      - globalstar-net

  db-sonar:
    image: postgres:13
    container_name: sonarqube-db
    restart: always
    environment:
      - POSTGRES_USER=sonar
      - POSTGRES_PASSWORD=sonar
      - POSTGRES_DB=sonar
    volumes:
      - sonar_db_data:/var/lib/postgresql/data
    networks:
      - globalstar-net

  # Sonar Scanner (Opcional: Roda a análise automaticamente ao subir)
  # Normalmente você roda isso na pipeline de CI/CD (GitHub Actions/Jenkins)
  # sonar-scanner-cli:
  #   image: sonarsource/sonar-scanner-cli
  #   depends_on:
  #     - sonarqube
  #     - backend
  #   volumes:
  #     - .:/usr/src
  #   command: >
  #     sonar-scanner 
  #     -Dsonar.projectKey=globalstar-iot 
  #     -Dsonar.sources=. 
  #     -Dsonar.host.url=http://sonarqube:9000 
  #     -Dsonar.login=admin 
  #     -Dsonar.password=admin

volumes:
  mysql_data:
  sonar_data:
  sonar_extensions:
  sonar_logs:
  sonar_db_data:

networks:
  globalstar-net:
    driver: bridge